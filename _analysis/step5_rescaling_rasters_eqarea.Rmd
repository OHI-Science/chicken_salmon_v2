---
title: "RescalingRaster"
output: html_document
editor_options: 
  chunk_output_type: console
---
This script uses the global total for each pressure across all food systems (in this case, broilers and aquaculture salmon) to rescale the raster cells, so each raster cell reflects the proportion of stressor it contributes to the global total.   

```{r}

library(raster)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(here)

```


Rescale each stressor across all inputs.  Data saved in rescaled/stressor folder.

```{r}

stressor_list <- c("ghg", "water", "nutrient", "disturbance")

rescaling_csv <- data.frame(stressor = stressor_list, global_total = NA)

for(stressor in stressor_list){
#stressor <- "ghg"
stressor_file <- raster(sprintf("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/stressor/%s_per_cell.tif", stressor))
resc_num <- cellStats(stressor_file, "sum", na.rm=TRUE)

rescaled_raster = raster::calc(stressor_file, fun=function(x){ifelse(x>0, 
                                       (x/resc_num)*1000000, 
                                       0)})
#plot(rescaled_raster)
#cellStats(rescaled_raster, "sum", na.rm=TRUE) # should equal 1...if not, something went wrong
writeRaster(rescaled_raster, sprintf("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/stressor/%s_rescaled.tif", stressor), overwrite=TRUE)
rescaling_csv$global_total[rescaling_csv$stressor == stressor] <- resc_num

}

write_csv(rescaling_csv, here("_analysis/step4_stressor_rescaling.csv"))
```


# chi
Sum all rescaled stressor files, saved here: rescaled/cumulative_stress
```{r}

chi_files <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/stressor", pattern="rescaled", full=TRUE)

chi_stack <- stack(chi_files)
chi <- sum(chi_stack, na.rm=TRUE)
writeRaster(chi, "/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/cumulative_stress/cumulative_stress.tif", overwrite=TRUE)

check <- raster("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/cumulative_stress/cumulative_stress.tif")
cellStats(check, "sum", na.rm=TRUE) # should be 4 x 1000000


```

# proportion of total chi for each food system/stressor
scaling each summed chicken and salmon stressor raster relative to the 99th quantile of both food systems combined.

```{r}

chi_rescale <- read_csv(here("_analysis/step4_stressor_rescaling.csv"))

## function
rescale_food_system <- function(chi_rescale, food_system="broiler"){
  
for(stressor in chi_rescale$stressor){ #stressor = "ghg"

stressor_system_file <- raster(sprintf("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/system_stressor/%s_%s_per_cell.tif", food_system, stressor))

resc_num <- chi_rescale$global_total[chi_rescale$stressor==stressor]

rescaled_raster = raster::calc(stressor_system_file, fun=function(x){ifelse(x>0, 
                                       (x/resc_num)*1000000, 
                                       0)})
#plot(rescaled_raster)
writeRaster(rescaled_raster, sprintf("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/system_stressor/%s_%s_rescaled.tif", food_system, stressor), overwrite=TRUE)
}
}


rescale_food_system(chi_rescale, food_system="broiler")
rescale_food_system(chi_rescale, food_system="salmon")

check <- raster("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/system_stressor/broiler_disturbance_rescaled.tif")
check
```


# rescaled for each food system/stressor/feed
scaling each summed chicken and salmon stressor raster relative to the 99th quantile of both food systems combined.

```{r}

chi_rescale <- read_csv(here("_analysis/step4_stressor_rescaling.csv"))

## function

for(stressor in chi_rescale$stressor){ #stressor = "disturbance"

stressor_system_files <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/feed_farm_system_stressor", pattern=stressor, full=TRUE)
file_names <- basename(stressor_system_files)
file_names <- gsub("_per_cell.tif", "", file_names)
file_names <- paste0(file_names, "_rescaled.tif")
stressor_system_stack <- stack(stressor_system_files)

resc_num <- chi_rescale$global_total[chi_rescale$stressor==stressor]

rescaled_raster_stack = raster::calc(stressor_system_stack, fun=function(x){ifelse(x>0, 
                                      (x/resc_num) * 1000000, 
                                       0)})
names(rescaled_raster_stack) <- file_names
for(i in 1:length(file_names)) { # i=1
  single_band <- raster(rescaled_raster_stack, layer = i)
  
writeRaster(single_band, sprintf("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/feed_farm_system_stressor/%s", names(single_band)),
              overwrite=TRUE)

}
}

```


## Get cumulative for chickens and salmon
```{r}

broilers <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/system_stressor", pattern="broiler", full=TRUE)
broilers_stack <- stack(broilers)
broilers_chi <- sum(broilers_stack, na.rm=TRUE)
writeRaster(broilers_chi, "/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/cumulative_stress/broilers_cumulative_stress.tif", overwrite=TRUE)

salmon <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/system_stressor", pattern="salmon", full=TRUE)
salmon_stack <- stack(salmon)
salmon_chi <- sum(salmon_stack, na.rm=TRUE)
writeRaster(salmon_chi, "/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/rescaled/cumulative_stress/salmon_cumulative_stress.tif", overwrite=TRUE)
plot(salmon_chi)
```


#quick checks
```{r}
cum <- raster("/home/shares/food-systems/Food_footprint/stressor_summary_new/rescaled/cumulative_stress/cumulative_stress.tif")
cellStats(cum, "sum", na.rm=TRUE) # should equal 4


salmon <- raster("/home/shares/food-systems/Food_footprint/stressor_summary_new/rescaled/cumulative_stress/salmon_cumulative_stress.tif")
broiler <- raster("/home/shares/food-systems/Food_footprint/stressor_summary_new/rescaled/cumulative_stress/broilers_cumulative_stress.tif")

total <- salmon+broiler
cellStats(total, "sum", na.rm=TRUE)
```