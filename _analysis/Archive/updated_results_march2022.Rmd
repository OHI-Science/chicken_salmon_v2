---
title: "Untitled"
author: "Caitie"
date: "01/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(here)
library(data.table)
library(raster)
library(tabularaster)

options(scipen = 999)
```

```{r}
un_geopolitical <- read_csv("/home/shares/food-systems/Food_footprint/chicken_salmon/_spatial/UNSD_Methodology.csv") %>%
  rename(georegion=Region_Name) %>% 
  dplyr::select(iso3c, georegion)

rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/land_eez_rgns.tif")
#plot(rgns)

rgn_names <- read_csv("/home/shares/food-systems/Food_footprint/chicken_salmon/_spatial/master_rgns.csv") %>%
  rename(land_area_km2 = area_km2)

eez_rgns <- read_csv("/home/shares/food-systems/Food_footprint/chicken_salmon/_spatial/eez_rgns.csv") %>%
  rename(eez_area_km2 = area_km2)

rescaling_values <- read_csv(here("_analysis/rescale_values.csv")) 
```
# Spatial data

# Max and min chicken and salmon CPI values

```{r}
broiler_cpi<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/rescaled_cumulative_pressure/chickens_cumulative_stress.tif")

salmon_cpi<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/rescaled_cumulative_pressure/salmon_cumulative_stress.tif")
```

These are the values - need to divide by 1000000

```{r}
cellStats(broiler_cpi, "max", na.rm = T)/1e6
```

```{r}
cellStats(salmon_cpi, "max", na.rm = T)/1e6
```


Load output file from step6

```{r}
results<-read.csv(here("_analysis/output_data/sum_pressures_country.csv"))
```

```{r}
pressures <- results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
  group_by(iso3c, Country, animal_system) %>% 
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  left_join(rgn_names) %>%
  left_join(eez_rgns) %>%
  rowwise() %>%
  mutate(cum_stress_km2= country_farm_feed_chi/(eez_area_km2 + land_area_km2)) %>%
  ungroup() %>%
   mutate(prop_of_global = ifelse(is.na(cum_stress_km2), 0, cum_stress_km2)) #%>%
```
# Land and sea area

```{r}
land_area<-sum(rgn_names$land_area_km2,na.rm = T)
eez_area<-sum(eez_rgns$eez_area_km2, na.rm = T)
```

# Production and cumulative pressures

```{r}
broiler_prod<-read.csv("/home/shares/food-systems/Food_footprint/chicken_salmon/production/broiler_production.csv")
salmon_prod<-read.csv("/home/shares/food-systems/Food_footprint/chicken_salmon/production/salmon_production.csv")
```

```{r}
sum(broiler_prod$broiler_slaughter_wt_tonnes,na.rm = T)/1000000
```

```{r}
sum(salmon_prod$fao_tonnes_production, na.rm = T)/1000000
```

```{r}
sum(broiler_prod$broiler_slaughter_wt_tonnes, na.rm = T)/sum(salmon_prod$fao_tonnes_production, na.rm = T)
```

# Comparing cumulative pressures of farmed chicken and salmon

Absolute pressure comparison

```{r}
chicken_disturb<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/chickens_disturbance_per_cell.tif")

salmon_disturb<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/salmon_disturbance_per_cell.tif")

all_chick_dist<-cellStats(chicken_disturb, "sum", na.rm = T)
all_salmon_dist<-cellStats(salmon_disturb, "sum", na.rm = T)

```

```{r}
chicken_nutri<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/chickens_nutrient_per_cell.tif")

salmon_nutri<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/salmon_nutrient_per_cell.tif")

all_chick_nutri<-cellStats(chicken_nutri, "sum", na.rm = T)
all_salmon_nutri<-cellStats(salmon_nutri, "sum", na.rm = T)

```

```{r}
chicken_fw<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/chickens_water_per_cell.tif")

salmon_fw<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/salmon_water_per_cell.tif")

all_chick_fw<-cellStats(chicken_fw, "sum", na.rm = T)
all_salmon_fw<-cellStats(salmon_fw, "sum", na.rm = T)

```

```{r}
chicken_ghg<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/chickens_ghg_per_cell.tif")

salmon_ghg<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor/salmon_ghg_per_cell.tif")

all_chick_ghg<-cellStats(chicken_ghg, "sum", na.rm = T)
all_salmon_ghg<-cellStats(salmon_ghg, "sum", na.rm = T)

```

How many times greater is chicken than salmon across pressures?

```{r}
all_chick_dist/all_salmon_dist
all_chick_nutri/all_salmon_nutri
all_chick_fw/all_salmon_fw
all_chick_ghg/all_salmon_ghg
```

Percent difference

```{r}
(all_chick_dist-all_salmon_dist)/all_salmon_dist
(all_chick_nutri-all_salmon_nutri)/all_salmon_nutri
(all_chick_fw-all_salmon_fw)/all_salmon_fw
(all_chick_ghg-all_salmon_ghg)/all_salmon_ghg
```

```{r}
chick_df<-data.frame(type = "chicken", stressor = c("Disturbance", "Freshwater use", "Nutrients", "GHG emissions"), value = c(all_chick_dist, all_chick_fw, all_chick_nutri, all_chick_ghg))

salmon_df<-data.frame(type = "salmon", stressor = c("Disturbance", "Freshwater use", "Nutrients", "GHG emissions"), value = c(all_salmon_dist, all_salmon_fw, all_salmon_nutri, all_salmon_ghg))

all<-rbind(chick_df, salmon_df)

write.csv(all, here("_analysis/figures/Pressure_comparison.csv"))
```

```{r}
animal_stressor<-results %>% 
  group_by(animal_system, stressor) %>% 
  summarise(total_dist = sum(value, na.rm = T))

animal_stressor_location<-results %>% 
  group_by(animal_system, stressor, location) %>% 
  summarise(total_pressure = sum(value, na.rm = T)) %>% 
  mutate(perc_area = ifelse(location == "land" & stressor == "disturbance", (total_pressure/land_area)*100,
                       ifelse(location == "marine" & stressor == "disturbance", (total_pressure/eez_area)*100, NA)))

#Total disturbance
broiler_dist<-animal_stressor %>% filter(animal_system == "chickens", stressor == "disturbance")
salmon_dist<-animal_stressor %>% filter(animal_system == "salmon", stressor == "disturbance")

broiler_dist #EEZ and land
salmon_dist #EEZ and Land

open_ocean_chicken <- all_chick_dist- as.numeric(broiler_dist$total_dist) # 1165.641
open_ocean_salmon <- all_salmon_dist- as.numeric(salmon_dist$total_dist) # 4341.202

#Total disturbance by location (excluding open ocean)
animal_stressor_location %>% filter(animal_system == "chickens", stressor == "disturbance")
animal_stressor_location %>% filter(animal_system == "salmon", stressor == "disturbance")

#Chicken percent by area excluding open ocean
chick_prop<-animal_stressor_location %>% 
  filter(animal_system == "chickens") %>% 
  ungroup() %>% 
  mutate(prop_pressure = ifelse(stressor == "disturbance", total_pressure/all_chick_dist,
                                ifelse(stressor == "ghg", total_pressure/all_chick_ghg,
                                       ifelse(stressor == "nutrient", total_pressure/all_chick_nutri, total_pressure/all_chick_fw))))#%>% 
  #dplyr::select(total_pressure) #%>% 
  #as.numeric()

#Salmon percent ocean excluding open ocean

salmon_prop<-animal_stressor_location %>% 
  filter(animal_system == "salmon") %>% 
  ungroup() %>% 
  mutate(prop_pressure = ifelse(stressor == "disturbance", total_pressure/all_salmon_dist,
                                ifelse(stressor == "ghg", total_pressure/all_salmon_ghg,
                                       ifelse(stressor == "nutrient", total_pressure/all_salmon_nutri, total_pressure/all_salmon_fw))))
```

```{r}
broilers <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor", pattern="chicken", full=TRUE)

broiler_stack<-stack(broilers)
broiler_df<-rasterToPoints(broiler_stack)

dist_rescale<-as.numeric(rescaling_values[3,2])
water_rescale<-as.numeric(rescaling_values[4,2])
ghg_rescale<-as.numeric(rescaling_values[1,2])
nutrient_rescale<-as.numeric(rescaling_values[2,2])

broiler_prop<-broiler_df %>% 
  as.data.frame() %>% 
  rename(disturbance = chickens_disturbance_per_cell,
         ghg = chickens_ghg_per_cell,
         nutrient = chickens_nutrient_per_cell,
         water = chickens_water_per_cell) %>% 
  mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutrient_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

max(broiler_prop$total_chi)
sum(broiler_prop$total_chi)
```

```{r}
salmon <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/raw_pressure_summary/system_stressor", pattern="salmon", full=TRUE)
salmon_stack <- stack(salmon)
salmon_df<-rasterToPoints(salmon_stack)

salmon_prop<-salmon_df %>% 
  as.data.frame() %>% 
  rename(disturbance = salmon_disturbance_per_cell,
         ghg = salmon_ghg_per_cell,
         nutrient = salmon_nutrient_per_cell,
         water = salmon_water_per_cell) %>% 
   mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutrient_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

max(salmon_prop$total_chi)
sum(salmon_prop$total_chi)
```
# Number of countries with production

```{r}
nrow(broiler_prod)
length(which(broiler_prod$broiler_slaughter_wt_tonnes>0))
```


```{r}
nrow(salmon_prod)
length(which(salmon_prod$fao_tonnes_production>0))
```



# Cumulative pressures (CPI)

```{r}
chicken<-raster("/home/shares/food-systems/Food_footprint/chicken_salmon/rescaled_cumulative_pressure/chickens_cumulative_stress.tif")

chicken2<-chicken/1000000

chicken_df<-rasterToPoints(chicken2) %>% 
  as.data.frame()

chicken_quant <- chicken2
values(chicken_quant)[values(chicken_quant) <=0 ] = NA

chick_quant_0 <- quantile(chicken_quant, 0)    
chick_quant_45 <- quantile(chicken_quant, 0.45) 
chick_quant_90 <- quantile(chicken_quant, 0.90) 

```

```{r}
length(which(chicken_df$chickens_cumulative_stress==0))/nrow(chicken_df)
length(which(chicken_df$chickens_cumulative_stress<chick_quant_45))/nrow(chicken_df)
length(which(chicken_df$chickens_cumulative_stress>chick_quant_90))/nrow(chicken_df)
```


```{r}
salmon <- raster("/home/shares/food-systems/Food_footprint/chicken_salmon/rescaled_cumulative_pressure/salmon_cumulative_stress.tif")

salmon2<-salmon/1000000

salmon_df<-rasterToPoints(salmon2) %>% 
  as.data.frame()

##remove NAs just for quantiles
salmon_quant <- salmon2
values(salmon_quant)[values(salmon_quant) <=0 ] = NA

salmon_quant_0 <- quantile(salmon_quant, 0)  
salmon_quant_45 <- quantile(salmon_quant, 0.45)  
salmon_quant_90 <- quantile(salmon_quant, 0.90) 

length(which(salmon_df$salmon_cumulative_stress==0))/nrow(salmon_df)
length(which(salmon_df$salmon_cumulative_stress<salmon_quant_45))/nrow(salmon_df)
length(which(salmon_df$salmon_cumulative_stress>salmon_quant_90))/nrow(salmon_df)
```
90% of CPI in what % of cells?

```{r}
cumsum_broiler<-broiler_cpi_df %>% 
  arrange(desc(broiler_cpi)) %>% 
  mutate(cumsum = cumsum(broiler_cpi),
         prop_cpi = cumsum/sum(broiler_cpi_df$broiler_cpi,na.rm = T))
         
broiler_90<-cumsum_broiler %>% 
  filter(prop_cpi<=0.95)

nrow(broiler_90)/nrow(broiler_cpi_df)
max(broiler_90$prop_cpi)
```

```{r}
cumsum_salmon<-salmon_cpi_df %>% 
  arrange(desc(salmon_cpi)) %>% 
  mutate(cumsum = cumsum(salmon_cpi),
         prop_cpi = cumsum/sum(salmon_cpi_df$salmon_cpi,na.rm = T))
         
salmon_90<-cumsum_salmon %>% 
  filter(prop_cpi<=0.95)

nrow(salmon_90)/nrow(salmon_cpi_df)
max(salmon_90$prop_cpi)
```

# Country CPI

```{r}
iso3_broiler_cpi<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   group_by(iso3c, Country, animal_system) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "chickens")


# Salmon CPI
iso3_salmon_cpi<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   group_by(iso3c, Country, animal_system) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "salmon") #%>% 
  #arrange(desc(country_farm_feed_chi)) %>% 
  #mutate(prop_total = country_farm_feed_chi/max(salmon_prop2$total_chi))

write.csv(iso3_broiler_cpi, here("_analysis/figures/Country_results/Broiler_country_cpi.csv"))
write.csv(iso3_salmon_cpi, here("_analysis/figures/Country_results/Salmon_country_cpi.csv"))

```

Countries that make up 75% of CPI for chicken and salmon

```{r}
iso3_salmon_cpi2<-iso3_salmon_cpi %>% 
  arrange(desc(country_farm_feed_chi)) %>% 
  ungroup() %>% 
  mutate(cpi_cumsum = cumsum(country_farm_feed_chi),
         prop_cpi = cpi_cumsum/sum(iso3_salmon_cpi$country_farm_feed_chi, na.rm = T)) 


salmon_75<-iso3_salmon_cpi2[which(iso3_salmon_cpi2$prop_cpi<=0.75),]

unique(salmon_75$Country)
```



``````{r}
iso3_broiler_cpi2<-iso3_broiler_cpi %>% 
  arrange(desc(country_farm_feed_chi)) %>% 
  ungroup() %>% 
  mutate(cpi_cumsum = cumsum(country_farm_feed_chi),
         prop_cpi = cpi_cumsum/sum(iso3_broiler_cpi$country_farm_feed_chi, na.rm = T)) 


broiler_75<-iso3_broiler_cpi2[which(iso3_broiler_cpi2$prop_cpi<=0.75),]

unique(broiler_75$Country)
```

```{r}
all_75<-rbind(broiler_75, salmon_75)

length(unique(all_75$Country))

which(broiler_75$Country %in% salmon_75$Country)
```

```{r}
broiler_cpi_prod<-full_join(iso3_broiler_cpi, broiler_prod, by = c("iso3c", "Country"))

salmon_cpi_prod<-full_join(iso3_salmon_cpi, salmon_prod, by = c("iso3c")) %>% 
  mutate(fao_tonnes_production = ifelse(is.na(fao_tonnes_production) == T, 0 , as.numeric(fao_tonnes_production)))
```

Correlation

```{r}
cor.test(broiler_cpi_prod$country_farm_feed_chi, broiler_cpi_prod$broiler_slaughter_wt_tonnes, type = "pearsons")
```

```{r}
cor.test(salmon_cpi_prod$country_farm_feed_chi, salmon_cpi_prod$fao_tonnes_production, type = "pearsons")
```


```{r}
iso3_broiler_cpi_prod<-broiler_cpi_prod %>% 
  mutate(cpi_prod = country_farm_feed_chi/broiler_slaughter_wt_tonnes) %>% 
  dplyr::select(iso3c, Country, country_farm_feed_chi, broiler_slaughter_wt_tonnes, cpi_prod)

iso3_salmon_cpi_prod<-salmon_cpi_prod %>% 
  mutate(cpi_prod = country_farm_feed_chi/fao_tonnes_production) %>% 
  dplyr::select(iso3c, Country, country_farm_feed_chi, fao_tonnes_production, cpi_prod)
```

```{r}
test<-iso3_broiler_cpi_prod %>% 
  filter(broiler_slaughter_wt_tonnes == 0)
```


# CPI per km2 by country

```{r}
broiler_cpi_km2<-full_join(iso3_broiler_cpi, rgn_names) %>%
  left_join(eez_rgns) %>%
  rowwise() %>%
  mutate(eez_area_km2 = ifelse(is.na(eez_area_km2) == T, 0, as.numeric(eez_area_km2)),
    cum_stress_km2= country_farm_feed_chi/(eez_area_km2 + land_area_km2)) %>%
  ungroup() %>%
   mutate(prop_of_global = ifelse(is.na(cum_stress_km2), 0, cum_stress_km2))

salmon_cpi_km2<-full_join(iso3_salmon_cpi, rgn_names) %>%
  left_join(eez_rgns) %>%
  rowwise() %>%
  mutate(eez_area_km2 = ifelse(is.na(eez_area_km2) == T, 0, as.numeric(eez_area_km2)),
    cum_stress_km2= country_farm_feed_chi/(eez_area_km2 + land_area_km2)) %>%
  ungroup() %>%
   mutate(prop_of_global = ifelse(is.na(cum_stress_km2), 0, cum_stress_km2))

write.csv(broiler_cpi_km2, here("_analysis/figures/Country_results/Broiler_country_cpi_km2.csv"))
write.csv(salmon_cpi_km2, here("_analysis/figures/Country_results/Salmon_country_cpi_km2.csv"))
```

```{r}
broiler_cpi_km2_prod<-full_join(broiler_cpi_km2, broiler_prod) %>% 
  mutate(prop_prod = broiler_slaughter_wt_tonnes/sum(broiler_cpi_prod$broiler_slaughter_wt_tonnes),
         total_area = land_area_km2 + eez_area_km2) #%>% 
  #filter(prop_prod >0.03)

salmon_cpi_km2_prod<-full_join(salmon_cpi_km2, salmon_prod)%>% 
  mutate(prop_prod = fao_tonnes_production/sum(salmon_cpi_prod$fao_tonnes_production),
         total_area = land_area_km2 + eez_area_km2) #%>% 
  #filter(prop_prod >0.05)
```

# Extract cells within each country

```{r}
rgns_proj<-projectRaster(rgns, crs = broiler_cpi)
rgns_rs<-resample(rgns_proj, broiler_cpi)

rgn_df<-tabularaster::as_tibble(rgns_rs) %>% 
  rename(ID_0 = cellvalue)

rgn_names_df<-full_join(rgn_names, rgn_df) %>% 
  group_by(iso3c, Country) %>% 
  mutate(ncells = length(unique(cellindex)))

broiler_cpi_df<-as_tibble(broiler_cpi) %>% 
  mutate(cellvalue = cellvalue/1000000) %>% 
  rename(broiler_cpi = cellvalue)

salmon_cpi_df<-as_tibble(salmon_cpi) %>% 
  mutate(cellvalue = cellvalue/1000000) %>% 
  rename(salmon_cpi = cellvalue)


iso3_cpi<-full_join(rgn_names_df, broiler_cpi_df) %>% 
  full_join(., salmon_cpi_df) 

bottom_5_perc<-iso3_cpi %>% 
  group_by(iso3c, Country) %>% 
  summarise(broiler_quant_5 = quantile(broiler_cpi, probs = 0.05, na.rm = T),
         salmon_quant_5 = quantile(salmon_cpi, probs = 0.05, na.rm = T))

rm_5<-full_join(iso3_cpi, bottom_5_perc) %>% 
  mutate(broiler_cpi2 = ifelse(broiler_cpi<=broiler_quant_5, 0, as.numeric(broiler_cpi)),
         salmon_cpi2 = ifelse(salmon_cpi<=salmon_quant_5, 0, as.numeric(salmon_cpi)))
  
test<-rm_5 %>% 
  group_by(iso3c, Country, ncells) %>% 
  summarise(broiler_cells = length(which(broiler_cpi2>0)),
         salmon_cells = length(which(salmon_cpi2>0))) %>% 
  mutate(prop_broiler = broiler_cells/ncells) %>% 
  filter(!is.na(iso3c) == T) %>% 
  full_join(., iso3_salmon_cpi) %>% 
  rename(salmon_cpi = country_farm_feed_chi) %>% 
  dplyr::select(-animal_system) %>% 
  full_join(., iso3_broiler_cpi) %>% 
  rename(chicken_cpi = country_farm_feed_chi) %>% 
  dplyr::select(-animal_system) %>% 
  mutate(broiler_cpi_cell = chicken_cpi/broiler_cells,
         salmon_cpi_cell = salmon_cpi/salmon_cells) %>% 
  full_join(., broiler_prod) %>% 
  full_join(., salmon_prod, by = c("Country" = "country", "iso3c"))

cells_iso3_cpi<- iso3_cpi %>% 
  group_by(iso3c, Country, ncells) %>% 
  summarise(broiler_cells = length(which(broiler_cpi>0)),
         salmon_cells = length(which(salmon_cpi>0))) %>% 
  mutate(prop_broiler = broiler_cells/ncells) %>% 
  filter(!is.na(iso3c) == T) %>% 
  full_join(., iso3_salmon_cpi) %>% 
  rename(salmon_cpi = country_farm_feed_chi) %>% 
  dplyr::select(-animal_system) %>% 
  full_join(., iso3_broiler_cpi) %>% 
  rename(chicken_cpi = country_farm_feed_chi) %>% 
  dplyr::select(-animal_system) %>% 
  mutate(broiler_cpi_cell = chicken_cpi/broiler_cells,
         salmon_cpi_cell = salmon_cpi/salmon_cells) %>% 
  full_join(., broiler_prod) %>% 
  full_join(., salmon_prod, by = c("Country" = "country", "iso3c"))

chicken_cells_iso3_cpi<-cells_iso3_cpi %>% 
  dplyr::select(-salmon_cpi,-salmon_cells, -salmon_cpi_cell)

write.csv(cells_iso3_cpi, here("_analysis/output_data/CPI_cells_by_country.csv"))
write.csv(test, here("_analysis/output_data/CPI_cells_by_country_top95perc.csv"))
```


# percent of the world with cpi

```{r}
broiler_cpi_cells<-broiler_cpi_df %>% 
  filter(broiler_cpi>0,
         !is.na(broiler_cpi) == T)
  
salmon_cpi_cells<-salmon_cpi_df %>% 
  filter(salmon_cpi>0,
         !is.na(salmon_cpi) == T)

nrow(broiler_cpi_cells)/nrow(broiler_cpi_df)

nrow(salmon_cpi_cells)/nrow(salmon_cpi_df)
```

```{r}
cor.test(cells_iso3_cpi$broiler_cells, cells_iso3_cpi$high_broiler, type = "pearsons")
```


```{r}
cor.test(cells_iso3_cpi$salmon_cells, cells_iso3_cpi$high_salmon, type = "pearsons")
```
```{r}
cor.test(cells_iso3_cpi$prop_salmon, cells_iso3_cpi$prop_high_salmon, type = "pearsons")
```
Countries with chicken CPI but no production
```{r}
length(which(broiler_cpi_prod$country_farm_feed_chi>0&broiler_cpi_prod$broiler_slaughter_wt_tonnes==0))
```

```{r}
length(which(salmon_cpi_prod$country_farm_feed_chi>0&salmon_cpi_prod$fao_tonnes_production==0))
```
# Cell count

```{r}
cell_count<-read.csv(here("_analysis/figures/overlap_map/data/cell_count.csv")) 

low_chicken<-cell_count %>% 
  filter(category %in% as.factor(c("low chicken\nzero salmon", "low chicken\nlow salmon","low chicken\nmedium salmon","low chicken\nhigh salmon")))

zero_chicken<-cell_count %>% 
  filter(category %in% as.factor(c("zero chicken\nzero salmon", "zero chicken\nlow salmon","zero chicken\nmedium salmon","zero chicken\nhigh salmon")))


low_salmon<-cell_count %>% 
  filter(category %in% as.factor(c("high chicken\nlow salmon","medium chicken\nlow salmon", "low chicken\nlow salmon","zero chicken\nlow salmon")))

zero_salmon<-cell_count %>% 
  filter(category %in% as.factor(c("high chicken\nzero salmon", "zero chicken\nzero salmon", "low chicken\nzero salmon", "medium chicken\nzero salmon")))

high_overlap<-cell_count %>% 
  filter(category %in% as.factor(c("high chicken\nhigh salmon")))

med_high_overlap<-cell_count %>% 
  filter(category %in% as.factor(c("high chicken\nmedium salmon", "medium chicken\nhigh salmon", "medium chicken\nmedium salmon")))

sum(med_high_overlap$prop_cells)

sum(zero_chicken$prop_cells)
sum(zero_salmon$prop_cells)
sum(low_chicken$prop_cells)
sum(low_salmon$prop_cells)
```

# Countries with CPI and not production

```{r}
length(which(broiler_cpi_prod$country_farm_feed_chi>0 & broiler_cpi_prod$broiler_count<=0))
length(which(salmon_cpi_prod$country_farm_feed_chi>0))

cor.test(broiler_cpi_prod$country_farm_feed_chi, broiler_cpi_prod$broiler_carcass_wt_tonnes, method = "pearson")

cor.test(salmon_cpi_prod$country_farm_feed_chi, salmon_cpi_prod$fao_tonnes_production, method = "pearson")


b_mod<-lm(country_farm_feed_chi~broiler_carcass_wt_tonnes, data = broiler_cpi_prod)
s_mod<-lm(country_farm_feed_chi~fao_tonnes_production, data = salmon_cpi_prod)

summary(b_mod)
summary(s_mod)

sub_broiler<-broiler_cpi_prod %>% 
  arrange(desc(country_farm_feed_chi)) 

sub_broiler#%>% 
  #filter(iso3c %in% c("USA", "CHN", "BRA", "IDN"))
```

```{r}
sub_salmon<-salmon_cpi_prod %>% 
  arrange(desc(country_farm_feed_chi)) 

sub_salmon#%>% 
 # filter(iso3c %in% c("NOR", "GBR", "CHL", "PER"))
```

```{r}
broiler_cpi_location<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   group_by(iso3c, Country, animal_system, location) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "chickens")


# Salmon CPI
salmon_cpi_location<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   group_by(iso3c, Country, animal_system, location) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "salmon") #%>% 
  #arrange(desc(country_farm_feed_chi)) %>% 
 # mutate(prop_total = country_farm_feed_chi/0.1771553)
```

```{r}
broiler_cpi_prod_loc<-full_join(broiler_cpi_location, broiler_prod, by = c("iso3c", "Country"))

broiler_cpi_prod_loc_marine<-full_join(broiler_cpi_location, broiler_prod, by = c("iso3c", "Country")) %>% 
  filter(location == "marine") %>% 
  pivot_wider(., names_from = "location", values_from = "country_farm_feed_chi") 

broiler_cpi_prod_loc_land<-full_join(broiler_cpi_location, broiler_prod, by = c("iso3c", "Country")) %>% 
  filter(location == "land") %>% 
  pivot_wider(., names_from = "location", values_from = "country_farm_feed_chi") 

broiler_cpi_prod_loc<-full_join(broiler_cpi_prod_loc_marine, broiler_cpi_prod_loc_land, by = c("iso3c", "Country")) %>% 
  dplyr::select(iso3c, Country, marine, land)

salmon_cpi_prod_loc_marine<-full_join(salmon_cpi_location, salmon_prod, by = c("iso3c", "Country" = "country")) %>% 
  filter(location == "marine") %>% 
  pivot_wider(., names_from = "location", values_from = "country_farm_feed_chi") 

salmon_cpi_prod_loc_land<-full_join(salmon_cpi_location, salmon_prod, by = c("iso3c", "Country" = "country")) %>% 
  filter(location == "land") %>% 
  pivot_wider(., names_from = "location", values_from = "country_farm_feed_chi") 

salmon_cpi_prod_loc<-full_join(salmon_cpi_prod_loc_marine, salmon_cpi_prod_loc_land, by = c("iso3c", "Country")) %>% 
  dplyr::select(iso3c, Country, marine, land)

length(which(broiler_cpi_prod_loc$marine>0 & broiler_cpi_prod_loc$land<=0))
length(which(broiler_cpi_prod_loc$marine<=0 & broiler_cpi_prod_loc$land>0))
length(which(broiler_cpi_prod_loc$marine>0 & broiler_cpi_prod_loc$land>0))
length(which(broiler_cpi_prod_loc$marine<=0 & broiler_cpi_prod_loc$land<=0))

length(which(salmon_cpi_prod_loc$marine>0 & salmon_cpi_prod_loc$land<=0))
length(which(salmon_cpi_prod_loc$marine<=0 & salmon_cpi_prod_loc$land>0))
length(which(salmon_cpi_prod_loc$marine>0 & salmon_cpi_prod_loc$land>0))
length(which(salmon_cpi_prod_loc$marine<=0 & salmon_cpi_prod_loc$land<=0))
```




# Overlap

```{r}
overlap <- cell_count %>% 
  filter(!category %in% c("zero chicken\nzero salmon", "high chicken\nzero salmon","low chicken\nzero salmon","zero chicken\nlow salmon","zero chicken\nmedium salmon","zero chicken\nhigh salmon","medium chicken\nzero salmon"))

no_zero_zero<-cell_count %>% 
  filter(!category %in% c("zero chicken\nzero salmon"))

sum(overlap$number_cells)/sum(no_zero_zero$number_cells) #85.6% overlap

test<-overlap %>% 
  mutate(prop_cell2=number_cells/sum(no_zero_zero$number_cells), # prop of cells with some CPI
         prop_cell3 = number_cells/sum(overlap$number_cells)) #prop of overlapping cells

sum(test$prop_cell2)
sum(test$prop_cell3)
sum(test$prop_cells)

```

# Feed CPI

```{r}
broiler_cpi_feed<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by= c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   group_by(animal_system, source2) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "chickens") 

broiler_cpi_feed<-broiler_cpi_feed %>% 
  mutate(prop = country_farm_feed_chi/sum(broiler_cpi_feed$country_farm_feed_chi))


# Salmon CPI
salmon_cpi_feed<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   group_by(animal_system, source2) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "salmon") %>% 
  mutate(prop = country_farm_feed_chi/sum(salmon_cpi_feed$country_farm_feed_chi))#%>% 
  #arrange(desc(country_farm_feed_chi)) %>% 
  #mutate(prop_total = country_farm_feed_chi/0.1771553)
```

# Feed stats

```{r}
animal_stressor_feed<-results %>% 
  mutate(source2 = ifelse(source == "farm", "farm", "feed")) %>% 
  group_by(animal_system, stressor, source2) %>% 
  summarise(total_pressure = sum(value, na.rm = T)) 

animal_stressor_feed_location<-results %>% 
   mutate(source2 = ifelse(source == "farm", "farm", "feed")) %>% 
  group_by(animal_system, stressor, source2, location) %>% 
  summarise(total_pressure = sum(value, na.rm = T)) 

# Disturbance  feed/farm
chick_dist_feed_farm<-animal_stressor_feed %>% 
  filter(animal_system == "chickens", stressor == "disturbance") %>% 
  mutate(prop = total_pressure/sum(total_pressure))
  #99.7% feed

salmon_dist_feed_farm<-animal_stressor_feed %>% 
  filter(animal_system == "salmon", stressor == "disturbance") %>% 
  mutate(prop = total_pressure/sum(total_pressure))# 99.9% feed


# GHG feed/farm
chick_ghg_feed<-animal_stressor_feed %>% 
  filter(animal_system == "chickens", stressor == "ghg") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#46.5% feed

salmon_ghg_feed<-animal_stressor_feed %>% 
  filter(animal_system == "salmon", stressor == "ghg") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#40.8% feed

# Freshwater  feed/farm
chick_fw_feed<-animal_stressor_feed %>% 
  filter(animal_system == "chickens", stressor == "water") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#99.7% feed

salmon_fw_feed<-animal_stressor_feed %>% 
  filter(animal_system == "salmon", stressor == "water") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#100% feed

# Nutrient  feed/farm
chick_nutri_feed<-animal_stressor_feed %>% 
  filter(animal_system == "chickens", stressor == "nutrient") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#11.3% feed

salmon_nutri_feed<-animal_stressor_feed %>% 
  filter(animal_system == "salmon", stressor == "nutrient") %>% 
  mutate(prop = total_pressure/sum(total_pressure))#3.8% feed
```


```{r}
broiler_cpi_km2_feed<-broiler_cpi_feed %>%
  mutate(cpi_km2 = country_farm_feed_chi/(land_area + eez_area))


salmon_cpi_km2_feed<-salmon_cpi_feed %>% 
  mutate(cpi_km2 = country_farm_feed_chi/(land_area + eez_area))
```

```{r}
# Chicken CPI
broiler_cpi_feed_farm_iso3<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   group_by(iso3c, Country, animal_system, source2) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "chickens") 

# Salmon CPI

salmon_cpi_feed_farm_iso3<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   group_by(iso3c, Country,animal_system, source2) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(animal_system == "salmon") 

write.csv(broiler_cpi_feed_farm_iso3, here("_analysis/output_data/Broiler_farm_feed_cpi.csv"))

write.csv(salmon_cpi_feed_farm_iso3, here("_analysis/output_data/Salmon_farm_feed_cpi.csv"))
```

```{r}
feed_location<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   group_by(source2, stressor, location) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>%
  filter(#animal_system == "salmon",
         source2 == "feed") %>% 
  mutate(cpi_km2 = ifelse(location == "land", country_farm_feed_chi/(land_area),
                               country_farm_feed_chi/(eez_area)))

feed_location

test<-results %>% 
 filter(stressor == "disturbance") %>% 
  mutate(source2 = ifelse(source == "farm", "farm", "feed")) %>% 
  group_by(source2, location) %>% 
  summarise(total_dist = sum(value)) %>% 
  filter(source2 == "feed")

test
```
# Dominant pressures

Not sure if I will do this.

```{r}
# 1 = disturbance, 2 = ghg, 3 = nutrients, 4 = water
dom_chicken<-fread(here("_analysis/figures/dominant_pressure_map/chicken_dominant_pressure.csv"))

dom_salmon<-fread(here("_analysis/figures/dominant_pressure_map/salmon_dominant_pressure.csv"))

```

```{r}
#Total cells = 14208000
n_cells_chicken_cpi<-length(which(is.na(dom_chicken$cat) == F))
n_cells_salmon_cpi<-length(which(is.na(dom_salmon$cat) == F))
```

Chicken
```{r}
#Disturbance
length(which(dom_chicken$cat == "disturbance"))/n_cells_chicken_cpi

#Nutrients
length(which(dom_chicken$cat == "nutrients"))/n_cells_chicken_cpi

#FW
length(which(dom_chicken$cat == "water"))/n_cells_chicken_cpi

#GHG
length(which(dom_chicken$cat == "ghg"))/n_cells_chicken_cpi
```


```{r}
farm_iso3_cpi_stressor<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total,
         source2 = ifelse(source == "farm", "farm", "feed")) %>%
   #group_by(iso3c, Country, source, subsource, animal_system, location, stressor) %>%
  group_by(iso3c, Country, animal_system, stressor, source2) %>% 
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>% 
  filter(animal_system == "chickens",
         source2 == "farm")

test<-farm_iso3_cpi_stressor %>% 
  filter(Country %in% c("United States", "China", "Brazil"))

test<-farm_iso3_cpi_stressor %>% 
  filter(Country == "Nauru")

ghg<-farm_iso3_cpi_stressor %>% 
  filter(stressor == "ghg")

mean(ghg$country_farm_feed_chi)

100-((244-157)/244*100)

#Nauru ranks 157 out of 244

nutrient<-farm_iso3_cpi_stressor %>% 
  filter(stressor == "nutrient")

mean(nutrient$country_farm_feed_chi)

#Naru ranks 150

100-((244-150)/244*100)

water<-farm_iso3_cpi_stressor %>% 
  filter(stressor == "water")

mean(water$country_farm_feed_chi)

#Nauru ranks 165

100-((244-165)/244*100)

dist<-farm_iso3_cpi_stressor %>% 
  filter(stressor == "disturbance")

mean(dist$country_farm_feed_chi)
median(dist$country_farm_feed_chi)

#Nauru ranks 161

100-((244-161)/244*100)
```

```{r}
iso3_cpi_stressor<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   #group_by(iso3c, Country, source, subsource, animal_system, location, stressor) %>%
  group_by(iso3c, Country, animal_system, stressor) %>% 
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>% 
  filter(animal_system == "chickens")

```

```{r}
chicken_cpi_stressor<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by="stressor") %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   #group_by(iso3c, Country, source, subsource, animal_system, location, stressor) %>%
  group_by(animal_system, stressor) %>% 
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>% 
  filter(animal_system == "broiler")

chicken_cpi_stressor <-chicken_cpi_stressor %>% 
  mutate(prop = country_farm_feed_chi/sum(chicken_cpi_stressor$country_farm_feed_chi))

chicken_cpi_stressor
```

salmon
```{r}
#Disturbance
length(which(dom_salmon$cat == "disturbance"))/n_cells_salmon_cpi

#Nutrients
length(which(dom_salmon$cat == "nutrients"))/n_cells_salmon_cpi

#FW
length(which(dom_salmon$cat == "water"))/n_cells_salmon_cpi

#GHG
length(which(dom_salmon$cat == "ghg"))/n_cells_salmon_cpi
```

```{r}
salmon_cpi_stressor<-results %>%
    filter(!is.na(Country)) %>% ## Antarctica
  left_join(rescaling_values, by="stressor") %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
   #group_by(iso3c, Country, source, subsource, animal_system, location, stressor) %>%
  group_by(animal_system, stressor) %>% 
  summarize(country_farm_feed_chi = sum(prop_of_global, na.rm=TRUE)) %>% 
  filter(animal_system == "salmon")

salmon_cpi_stressor <-salmon_cpi_stressor %>% 
  mutate(prop = country_farm_feed_chi/sum(salmon_cpi_stressor$country_farm_feed_chi))

salmon_cpi_stressor
```

```{r}
rgns <- raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/land_eez_rgns.tif")
plot(rgns)

rgs2<-raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/master_rgns_gall_peters.tif")

rgs2[rgs2>0]<-1

eez<-rgs2
eez[eez == 1]<-0
eez[is.na(eez) == T]<-1

salmon <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/system_stressor", pattern="salmon", full=TRUE)
salmon_stack <- stack(salmon)
```

Salmon ocean dominant pressures
```{r}
dom_salmon_ocean<-salmon_stack * eez


salmon_df<-rasterToPoints(dom_salmon_ocean)

salmon_prop_ocean<-salmon_df %>% 
  as.data.frame() %>%
  rename(disturbance = layer.1,
         ghg = layer.2,
         nutrient = layer.3,
         water = layer.4) %>% 
  mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutri_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

salmon_max_ocean<-salmon_prop_ocean %>% 
  mutate(max_val = ifelse(prop_dist > prop_ghg & prop_dist > prop_nutri & prop_dist > prop_water, 1,
                          ifelse(prop_ghg > prop_dist & prop_ghg > prop_nutri & prop_ghg > prop_water, 2,
                                 ifelse(prop_nutri > prop_dist & prop_nutri > prop_ghg & prop_nutri > prop_water,3,
                                        ifelse(prop_water > prop_dist & prop_water > prop_ghg & prop_water > prop_nutri, 4, NA))))) %>% 
  dplyr::select(x,y,max_val) %>% 
  mutate(cat = ifelse(max_val == 1, "disturbance",
                      ifelse(max_val == 2,"ghg",
                             ifelse(max_val == 3, "nutrients",
                                    ifelse(max_val == 4, "water", NA)))))
```

Salmon land dominant pressure

```{r}
dom_salmon_land<-salmon_stack * rgs2

salmon_df<-rasterToPoints(dom_salmon_land)

salmon_prop_land<-salmon_df %>% 
  as.data.frame() %>%
  rename(disturbance = layer.1,
         ghg = layer.2,
         nutrient = layer.3,
         water = layer.4) %>% 
  mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutri_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

salmon_max_land<-salmon_prop_land %>% 
  mutate(max_val = ifelse(prop_dist > prop_ghg & prop_dist > prop_nutri & prop_dist > prop_water, 1,
                          ifelse(prop_ghg > prop_dist & prop_ghg > prop_nutri & prop_ghg > prop_water, 2,
                                 ifelse(prop_nutri > prop_dist & prop_nutri > prop_ghg & prop_nutri > prop_water,3,
                                        ifelse(prop_water > prop_dist & prop_water > prop_ghg & prop_water > prop_nutri, 4, NA))))) %>% 
  dplyr::select(x,y,max_val) %>% 
  mutate(cat = ifelse(max_val == 1, "disturbance",
                      ifelse(max_val == 2,"ghg",
                             ifelse(max_val == 3, "nutrients",
                                    ifelse(max_val == 4, "water", NA)))))
```


```{r}
#Disturbance
length(which(dom_salmon$cat == "disturbance"))/n_cells_salmon_cpi
length(which(salmon_max_ocean$cat == "disturbance"))/n_cells_salmon_cpi 
length(which(salmon_max_land$cat == "disturbance"))/n_cells_salmon_cpi


#Nutrients
length(which(dom_salmon$cat == "nutrients"))/n_cells_salmon_cpi
length(which(salmon_max_ocean$cat == "nutrients"))/n_cells_salmon_cpi
length(which(salmon_max_land$cat == "nutrients"))/n_cells_salmon_cpi


#FW
length(which(dom_salmon$cat == "water"))/n_cells_salmon_cpi
length(which(salmon_max_ocean$cat == "water"))/n_cells_salmon_cpi
length(which(salmon_max_land$cat == "water"))/n_cells_salmon_cpi

#GHG
length(which(dom_salmon$cat == "ghg"))/n_cells_salmon_cpi
length(which(salmon_max_ocean$cat == "ghg"))/n_cells_salmon_cpi
length(which(salmon_max_land$cat == "ghg"))/n_cells_salmon_cpi

```

Chicken ocean dominant pressures
```{r}
broilers <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/equal_area/system_stressor", pattern="broiler", full=TRUE)
broiler_stack<-stack(broilers)

dom_chicken_ocean<-broiler_stack * eez


chicken_df<-rasterToPoints(dom_chicken_ocean)

chicken_prop_ocean<-chicken_df %>% 
  as.data.frame() %>%
  rename(disturbance = layer.1,
         ghg = layer.2,
         nutrient = layer.3,
         water = layer.4) %>% 
  mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutri_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

chicken_max_ocean<-chicken_prop_ocean %>% 
  mutate(max_val = ifelse(prop_dist > prop_ghg & prop_dist > prop_nutri & prop_dist > prop_water, 1,
                          ifelse(prop_ghg > prop_dist & prop_ghg > prop_nutri & prop_ghg > prop_water, 2,
                                 ifelse(prop_nutri > prop_dist & prop_nutri > prop_ghg & prop_nutri > prop_water,3,
                                        ifelse(prop_water > prop_dist & prop_water > prop_ghg & prop_water > prop_nutri, 4, NA))))) %>% 
  dplyr::select(x,y,max_val) %>% 
  mutate(cat = ifelse(max_val == 1, "disturbance",
                      ifelse(max_val == 2,"ghg",
                             ifelse(max_val == 3, "nutrients",
                                    ifelse(max_val == 4, "water", NA)))))
```

Chicken land dominant pressure

```{r}
dom_chicken_land<-broiler_stack * rgs2

chicken_df<-rasterToPoints(dom_chicken_land)

chicken_prop_land<-chicken_df %>% 
  as.data.frame() %>%
  rename(disturbance = layer.1,
         ghg = layer.2,
         nutrient = layer.3,
         water = layer.4) %>% 
  mutate(disturbance_cell_prop = disturbance/dist_rescale,
         water_cell_prop = water/water_rescale,
         ghg_cell_prop = ghg/ghg_rescale,
         nutrient_cell_prop = nutrient/nutri_rescale) %>% 
  mutate(total_chi = disturbance_cell_prop + ghg_cell_prop+ nutrient_cell_prop+water_cell_prop,
         prop_dist = disturbance_cell_prop/total_chi,
         prop_ghg = ghg_cell_prop/total_chi,
         prop_nutri = nutrient_cell_prop/total_chi,
         prop_water = water_cell_prop/total_chi) %>% 
  filter(!total_chi == 0)

chicken_max_land<-chicken_prop_land %>% 
  mutate(max_val = ifelse(prop_dist > prop_ghg & prop_dist > prop_nutri & prop_dist > prop_water, 1,
                          ifelse(prop_ghg > prop_dist & prop_ghg > prop_nutri & prop_ghg > prop_water, 2,
                                 ifelse(prop_nutri > prop_dist & prop_nutri > prop_ghg & prop_nutri > prop_water,3,
                                        ifelse(prop_water > prop_dist & prop_water > prop_ghg & prop_water > prop_nutri, 4, NA))))) %>% 
  dplyr::select(x,y,max_val) %>% 
  mutate(cat = ifelse(max_val == 1, "disturbance",
                      ifelse(max_val == 2,"ghg",
                             ifelse(max_val == 3, "nutrients",
                                    ifelse(max_val == 4, "water", NA)))))
```

```{r}
#Disturbance
length(which(dom_chicken$cat == "disturbance"))/n_cells_chicken_cpi
length(which(chicken_max_ocean$cat == "disturbance"))/n_cells_chicken_cpi 
length(which(chicken_max_land$cat == "disturbance"))/n_cells_chicken_cpi


#Nutrients
length(which(dom_chicken$cat == "nutrients"))/n_cells_chicken_cpi
length(which(chicken_max_ocean$cat == "nutrients"))/n_cells_chicken_cpi
length(which(chicken_max_land$cat == "nutrients"))/n_cells_chicken_cpi


#FW
length(which(dom_chicken$cat == "water"))/n_cells_chicken_cpi
length(which(chicken_max_ocean$cat == "water"))/n_cells_chicken_cpi
length(which(chicken_max_land$cat == "water"))/n_cells_chicken_cpi

#GHG
length(which(dom_chicken$cat == "ghg"))/n_cells_chicken_cpi
length(which(chicken_max_ocean$cat == "ghg"))/n_cells_chicken_cpi
length(which(chicken_max_land$cat == "ghg"))/n_cells_chicken_cpi

```