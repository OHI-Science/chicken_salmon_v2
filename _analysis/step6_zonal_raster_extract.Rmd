---
title: "Raster extract"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}

library(raster)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(here)

```



## Summed stressors for each region

Use land/eez raster to extract the summed pressures on land in eez areas.

```{r}

rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/land_eez_rgns.tif")
#plot(rgns)

rgn_names <- read_csv("/home/shares/food-systems/Food_footprint/chicken_salmon/_spatial/master_rgns.csv") %>%
  rename(land_area_km2 = area_km2)

eez_rgns <- read_csv("/home/shares/food-systems/Food_footprint/chicken_salmon/_spatial/eez_rgns.csv") %>%
  rename(eez_area_km2 = area_km2)

rescaling_values <- read_csv(here("_analysis/rescale_values.csv")) 
```



Zonal sum of land-based rasters:

```{r}

#crops <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/lat_long_per_cell/feed_farm_system_stressor", pattern="feed_crop",
#           full=TRUE)

crops <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/_tif_equal_area_proj_per_cell", pattern="feedcrop",
           full=TRUE)

#broiler_farms <- list.files("/home/shares/food-systems/Food_footprint/stressor_summary/lat_long_per_cell/feed_farm_system_stressor",
#                            pattern = "farm_broiler", full=TRUE)


broiler_farms <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/_tif_equal_area_proj_per_cell",
                            pattern = "farm_land_chickens", full=TRUE)

land_based <- c(crops, broiler_farms)
land_stack <- stack(land_based)

```

```{r}
rgns_proj<-projectRaster(rgns, crs = crs(land_stack))
rgns_proj2<-resample(rgns_proj, land_stack)

```

```{r}
land_data <- zonal(land_stack, rgns_proj2, fun="sum", progress="text", na.rm=TRUE)

land_data_df <- data.frame(land_data) %>%
  rename(ID_0 = zone) %>%
 # left_join(rgn_names, by="ID_0") %>%
 # tidyr::pivot_longer(-c(ID_0, iso3c, Country), names_to = "source", values_to = "value") %>%  
  tidyr::pivot_longer(-c(ID_0), names_to = "source", values_to = "value") %>%
  mutate(source = gsub("gall_peter_","",as.character(source))) %>% 
  separate(source, sep="_", into=c("source", "subsource", "animal_system", "type", "type2", "stressor")) %>%
  mutate(stressor = ifelse(is.na(stressor), animal_system, stressor)) %>%
  mutate(animal_system = ifelse(animal_system==stressor, NA, animal_system)) %>%
  mutate(animal_system = ifelse(is.na(animal_system), subsource, animal_system)) %>%
    mutate(subsource = ifelse(animal_system==subsource, NA, subsource)) %>%
  mutate(location = "land")

  
```


Zonal sum of marine-based rasters:

```{r}

fisheries <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/_tif_equal_area_proj_per_cell", pattern="feedfofm",
           full=TRUE)

salmon_farms <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/_tif_equal_area_proj_per_cell",
                            pattern = "farm_marine_salmon", full=TRUE)
marine_based <- c(fisheries, salmon_farms)
marine_stack <- stack(marine_based)

marine_data <- zonal(marine_stack, rgns_proj2, fun="sum", progress="text", na.rm=TRUE)

marine_data_df <- data.frame(marine_data) %>%
  rename(ID_0 = zone) %>%
#  left_join(rgn_names, by="ID_0") %>%
#  tidyr::pivot_longer(-c(ID_0, iso3c, Country), names_to = "source", values_to = "value") %>%
    tidyr::pivot_longer(-c(ID_0), names_to = "source", values_to = "value") %>%
   mutate(source = gsub("gall_peter_","",as.character(source))) %>% 
  separate(source, sep="_", into=c("source", "subsource", "animal_system", "type", "type2", "stressor")) %>%
  mutate(stressor = ifelse(is.na(stressor), animal_system, stressor)) %>%
  mutate(animal_system = ifelse(animal_system==stressor, NA, animal_system)) %>%
  mutate(animal_system = ifelse(is.na(animal_system), subsource, animal_system)) %>%
    mutate(subsource = ifelse(animal_system==subsource, NA, subsource)) %>%
  mutate(location = "marine")
  

```

combine data
```{r}

all_data <- rbind(marine_data_df, land_data_df) %>%
  left_join(rgn_names) %>%
  left_join(eez_rgns)


write_csv(all_data, here("_analysis/output_data/sum_pressures_country.csv"))
```


## Summarize data: broiler/salmon/farm/feed_crop/feed_marine

```{r}

sum_df <- read_csv(here("_analysis/output_data/sum_pressures_country.csv")) 

sum_df2 <- sum_df %>%
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
  group_by(iso3c, Country, source, subsource, type, type2, animal_system, location) %>%
  summarize(country_farm_feed_chi = sum(prop_of_global)) %>%
  left_join(rgn_names) %>%
  left_join(eez_rgns) %>%
  rowwise() %>%
  mutate(avg_chi_km2_1e_9= ifelse(location=="marine", 
                          country_farm_feed_chi/eez_area_km2*1000000000,
                          country_farm_feed_chi/land_area_km2*1000000000)) %>%
  group_by(iso3c, Country) %>%
  
  ### MRF: offhand: I'm not sure it makes sense to sum these (I think it would make sense to sum within a location), although not sure how used:
  mutate(total_avg_chi = sum(avg_chi_km2_1e_9, na.rm=TRUE))

tmp2 <- filter(sum_df2, iso3c=="USA") %>%
  data.frame() %>%
  rowwise() %>%
  mutate(test = country_farm_feed_chi/(land_area_km2 + eez_area_km2)*1000000)
arrange(sum_df, -total_avg_chi)

sum(tmp2$country_farm_feed_chi)
0.7850118


```


### Compare cumulative pressures in eez to total ocean

```{r}
sum(sum_df2$country_farm_feed_chi[sum_df2$location == "marine"], na.rm = T) 
sum(sum_df2$country_farm_feed_chi[sum_df2$location == "land"], na.rm = T) 

#compare to total ocean
marine <- list.files("/home/shares/food-systems/Food_footprint/chicken_salmon/_tif_equal_area_proj_per_cell_rescaled", full=TRUE)
feed <- grep("feedfofm", marine, value=TRUE)
farm <- grep("farm_marine_salmon", marine, value=TRUE)
marine_stack <- stack(c(farm, feed))
marine_total <- sum(marine_stack, na.rm=TRUE)
cellStats(marine_total, "sum", na.rm=TRUE)/1000000

0.1690388/0.1749438 ## 0.9662463, proportion of cumulative disturbance accounted for within EEZ areas  vs. open ocean
```

Checking to see what this all means.

This sort of checks out (but want to check areas): We get same total chi summed throughout a country.

To get chi per km2 (counting land and water) above, I think we need to change the calculation to calculate total chi across water and land and then divide by total area of land and water.  
Done this way: Our chi per km2 is lower but that is because our area estimates above are higher.  Probably need to check the areas in above data sheet (these may be based on buffered areas that we used to make sure there were no gaps between the eez and land, may need to calculate areas from original land/eezs).

```{r}

rescaled <- raster("/home/shares/food-systems/Food_footprint/chicken_salmon/rescaled_cumulative_pressure/cumulative_stress.tif")
cellStats(rescaled, "sum", na.rm=TRUE)
land <- rgns_proj2


cellStats(land, function(x,...) sum(x==243, na.rm=TRUE))

zonal_sum <- zonal(rescaled, land, "sum", na.rm=TRUE)
## This matches the sum above

## MRF NOTE: not sure what is going on here
land_pressure <- stack(rescaled, land)
land_pressure_df <- as.data.frame(land_pressure) %>%
  filter(master_rgns_gall_peters)
## MRF End

zonal_sum <- data.frame(zonal_sum) %>%
  rename(ID_0 = zone) %>%
  left_join(rgn_names, by="ID_0")
filter(zonal_sum, iso3c=="USA")
785011.8/505014  ##cumulative divided by number of cells
1.554436 # same as taking mean

785011.8/(505014*36)  ## cumulative divided by area
0.04317877 ## cumualative per km2 from raster area

18180504  # area from raster data

#area we have above is larger (not sure why the difference):
9473015+10578339
20051354
785011.8/20051354  
0.03915006 # smaller chi per km2, but this is due to differences in area estimates

zonal_avg <- zonal(rescaled, land, "mean", na.rm=TRUE)
zonal_avg <- data.frame(zonal_avg) %>%
  rename(ID_0 = zone) %>%
  left_join(rgn_names, by="ID_0")

# this is mean per cell, cell 36km2
filter(zonal_avg, iso3c=="USA")
1.55

## I think this would be correct, but I am concerned that the land area may be wrong (9.15 million km2 according to world bank)

sum_df <- read_csv(here("_analysis/output_data/sum_pressures_country.csv")) %>%
  filter(location == "land") %>%
  left_join(rescaling_values, by=c("stressor" = "pressure")) %>%
  rowwise() %>%
  mutate(prop_of_global = value/global_total) %>%
  group_by(iso3c, Country) %>%
  summarize(country_chi = sum(prop_of_global)) %>%
  left_join(rgn_names) %>%
  rowwise() %>%
  mutate(mean_chi= country_chi/land_area_km2)
filter(sum_df, iso3c=="USA")

```