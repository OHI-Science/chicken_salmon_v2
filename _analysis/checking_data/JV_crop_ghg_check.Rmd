---
title: "crop_ghg_check"
author: "Juliette"
date: "6/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

prep <- "/home/shares/food-systems/Food_footprint/dataprep/"
library(tidyverse)
library(here)

rgns_tif <- raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/master_rgns.tif")
food_crs <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
rgn_info <- read_csv(here("_spatial/output/master_rgns.csv"))

```

Create a pie chart showing the relative values among the following categories and a table showing absolute value:
  1. fert production
  2. pest production
  3. fert soil metabolism
  4. crop residues
  5. machinery direct costs
  6. irrigation
  7. crop burning
  8. manure management (from chickens)
  9. manure on field (from chickens)
  10. manure spread (from chickens)
  
GHG from crops:

1. fert production
```{r}
fert_prod_list <- (list.files(file.path(prep, "crop_ghg/crop_nutrient_ghg"), pattern = "all_nutrient", full = TRUE) )

stack_fert_prod <- raster::stack(lapply(fert_prod_list, raster))
fert_prod <- sum(stack_fert_prod, na.rm = TRUE)
names(fert_prod)<- "fertilizer production"
```

2. pest production
```{r}
pest_prod_list <- (list.files(file.path(prep, "crop_ghg/crop_pesticide_ghg"), full = TRUE) )
stack_pest_prod <- raster::stack(lapply(pest_prod_list, raster))
pest_prod <- sum(stack_pest_prod, na.rm = TRUE)
names(pest_prod)<- "pesticide production"
```

3. fert soil metabolism
```{r}
fert_meta_list <- (list.files(file.path(prep, "crop_ghg/crop_fertilizer_N2O/co2_eq"), full = TRUE) )
stack_fert_meta <- raster::stack(lapply(fert_meta_list, raster))
fert_meta <- sum(stack_fert_meta, na.rm = TRUE)
names(fert_meta)<- "fertilizer soil metabolism"
```

4. crop residues metabolism
```{r}
crop_res_list <- (list.files(file.path(prep, "crop_ghg/crop_residue_N2O/co2_eq"), full = TRUE) )

stack_crop_res <- raster::stack(lapply(crop_res_list, raster))
crop_res <- sum(stack_crop_res, na.rm = TRUE)
names(crop_res)<- "crop residue metabolism"
```



5. machinery direct costs
```{r}
machinery_list <- (list.files(file.path(prep, "crop_ghg/crop_machinery_ghg/total_em_crop"), full = TRUE) )
stack_machinery <- raster::stack(lapply(machinery_list, raster))
machinery <- sum(stack_machinery, na.rm = TRUE)
names(machinery)<- "machinery"
```

6. irrigation
```{r}
irrigation_list <- (list.files(file.path(prep, "crop_ghg/crop_irrigation_ghg/ghg_emissions"), full = TRUE))
stack_irrigation <- raster::stack(lapply(irrigation_list, raster))
irrigation <- sum(stack_irrigation, na.rm = TRUE)
names(irrigation)<- "irrigation"
```

7. crop burning
```{r}
res_burn_list <- (list.files(file.path(prep, "crop_ghg/crop_residue_burning_ghg/co2eq_emitted"), full = TRUE))

stack_res_burn <- raster::stack(lapply(res_burn_list, raster))
res_burn <- sum(stack_res_burn, na.rm = TRUE)
names(res_burn)<- "residue burning"
```
18634.97

Combine and create one df
```{r}

combine_rasts <- stack(fert_prod, pest_prod, fert_meta,crop_res, machinery, irrigation, res_burn, rgns_tif)
crop_ghg_df <- as.data.frame(combine_rasts, xy=TRUE)   

ghg <- crop_ghg_df %>% 
  rename(ID_0 = master_rgns) %>%
  group_by(ID_0) %>% 
  dplyr::summarise(fertilizer_production = sum(fertilizer.production, na.rm = TRUE),
                   pesticide_production = sum(pesticide.production, na.rm = TRUE),
                   fertilizer_soil_metabolism = sum(fertilizer.soil.metabolism, na.rm = TRUE),
                   crop_residue_metabolism = sum(crop.residue.metabolism, na.rm = TRUE),
                   machinery = sum(machinery, na.rm = TRUE),
                   irrigation = sum(irrigation, na.rm = TRUE),
                   residue_burning = sum(residue.burning, na.rm = TRUE))

crop_ghg <- ghg %>%
  left_join(rgn_info, by="ID_0") %>% 
  dplyr::select(-ID_0) %>% 
  pivot_longer(cols = -c("iso3c", "Country"), names_to = "source", values_to = "tonnes_co2eq") %>% 
  rename(country = Country) %>% 
  group_by(source) %>% 
  summarize(tonnes_co2eq = sum(tonnes_co2eq)) %>% 
  mutate(total_co2eq = sum(tonnes_co2eq))

##plot
crop <- ggplot(crop_ghg, aes(x="", y=tonnes_co2eq, fill=source)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)

#ggsave("crop_ghg_pie.jpg", width=5, height=3, dpi=300)
```



Now add chicken manure for total check :

Now grab the ghg from chicken manure that is applied to fields (we included it in the chicken ghg, but want it here too for magnitude comparison)

8. manure management (from chickens)
9. manure on field (from chickens)
10. manure spread (from chickens)

```{r}
manure <- read_csv(here("chicken_ghg/data/fao_manure_emissions.csv"))
```


Combine the pieces
```{r}
manure_total <- manure %>% 
  group_by(source) %>% 
  summarize(tonnes_co2eq = sum(tonnes_co2eq)) %>% 
  mutate(total_co2eq = sum(tonnes_co2eq))
  
crop_ghg_rgn<- rbind(crop_ghg, manure_total)

crop_ghg_totals <- crop_ghg_rgn %>% 
  group_by(source) %>% 
  summarize(tonnes_co2eq = sum(tonnes_co2eq))

```

Pie chart

```{r}
all <- ggplot(crop_ghg_totals, aes(x="", y=tonnes_co2eq, fill=source)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)
```




