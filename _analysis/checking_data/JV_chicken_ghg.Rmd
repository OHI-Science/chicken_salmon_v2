---
title: "JV_chicken_ghg"
author: "Juliette"
date: "6/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(here)
library(countrycode)
prep <- "/home/shares/food-systems/Food_footprint/dataprep/"
```


I. Summarize and report on chicken enteric fermentation (expectation is that this is zero)

```{r}
gleam <- read_csv(here("chicken_farm/data/chickens_GLEAMi_v2.csv")) %>%
    dplyr::filter(Production_system %in% c("Broilers"))

gleam_enteric <- gleam %>%
  filter(Variable == "EMSS: Enteric - CH4 from enteric fermentation") %>%
  group_by(Country, iso3c) %>%
  dplyr::summarize(kg_CO2eq_per_year = sum(Value)) %>%
  ungroup()
```

Checks out! It's all zeros

II. Compare direct (on the farm) energy use. Compare our raster values to GLEAM values. Two options: compare total global sum of GLEAM directly to sum of our raster (This will not match exactly because there are different numbers of chickens, etc.). Compare the per chicken values.


```{r}
rgns_tif <- raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/master_rgns.tif")
food_crs <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
rgn_info <- read_csv(here("_spatial/output/master_rgns.csv"))
```

Calculate total emissions from direct energy production from our maps
```{r}
energy_broiler_ghg <- read_csv(file.path(prep, "/chicken_ghg/broiler_ghg.csv"), col_types = "ddn") %>% 
  rasterFromXYZ(crs = food_crs)

combine_rasts <- stack(energy_broiler_ghg, rgns_tif)
broiler_ghg_df <- as.data.frame(combine_rasts, xy=TRUE)   

broiler_ghg <- broiler_ghg_df %>% 
  rename(ID_0 = master_rgns) %>%
  group_by(ID_0) %>% 
  dplyr::summarise(our_ghg_tonnes = sum(broiler_ghg_CO2eq_tonnes, na.rm = TRUE))

broiler_ghg <- broiler_ghg %>%
  left_join(rgn_info, by="ID_0") 

```

Grab total emissions from direct energy concumsuption reported in GLEAM

```{r}
gleam_energy <- gleam %>%
  filter(Variable ==  "EMSS: Energy - CO2 direct energy use") %>%
  mutate(gleam_ghg_tonnes = Value/1000) %>% 
  rename(gleam_country = Country) %>% 
  dplyr::select(gleam_country, iso3c, gleam_ghg_tonnes)
```

Compare the two
```{r}

setdiff(gleam_energy$iso3c, broiler_ghg$iso3c)
setdiff(broiler_ghg$iso3c, gleam_energy$iso3c)

compare_broiler_ghg <- left_join(broiler_ghg, gleam_energy, by = "iso3c") %>% 
  mutate(per_diff = abs(gleam_ghg_tonnes-our_ghg_tonnes)/((gleam_ghg_tonnes+our_ghg_tonnes)/2))
```

Eh these numbers seem kind of a lot different so I'm going to check the per chicken ghg emission

A. GHG emission/ chicken from gleam data
```{r}
gleam_energy_per_chick <- gleam %>%
  filter(Variable ==  "EMSS: Energy - CO2 direct energy use" | Variable ==  "HERD: total number of animals") %>%
  pivot_wider(names_from = Variable, values_from = Value) %>% 
  rename(gleam_ghg ='EMSS: Energy - CO2 direct energy use',
         heads = 'HERD: total number of animals') %>% 
  group_by(Country, iso3c) %>% 
  dplyr::summarise(gleam_ghg = sum(gleam_ghg, na.rm = TRUE),
                   heads = sum(heads, na.rm = TRUE)) %>% 
  mutate(gleam_ghg_tonnes = gleam_ghg/1000,
         gleam_per_chick = gleam_ghg_tonnes/heads,
         gleam_per_chick = ifelse(is.na(gleam_per_chick), 0, gleam_per_chick)) %>% 
  rename(gleam_country = Country) %>% 
  dplyr::select(gleam_country, iso3c, gleam_per_chick)

```

B. GHG emission/ chicken from our data

Calculate the total number of chickens from our maps
```{r}
chicken_location <- read_csv(file.path(prep, "chicken_farm/chickens_spatial_df_gf.csv"), col_types = "ddcccddddccc") 

chicken_count <- chicken_location %>% 
  dplyr::select(iso3c, broiler_count) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total_chickens = sum(broiler_count, na.rm = TRUE))

ghg_per_chicken <- left_join(broiler_ghg, chicken_count, by = "iso3c") %>% 
  mutate(our_per_chick = our_ghg_tonnes/total_chickens) %>% 
  dplyr::select(Country, iso3c, our_per_chick)

```

Compare per chicken ghg emissions from our maps to the GLEAM data
```{r}
compare_per_chick <- left_join(ghg_per_chicken, gleam_energy_per_chick, by = "iso3c") %>% 
  mutate(per_diff = abs(our_per_chick-gleam_per_chick)/((our_per_chick+gleam_per_chick)/2))
```


III. Compare the manure raster data to the FAO manure data.

```{r}
our_manure <- read_csv(file.path(prep, "chicken_ghg/chicken_manure_emissions.csv"), col_types = "ddn") %>% 
  rasterFromXYZ(crs = food_crs)

combine_rasts <- stack(our_manure, rgns_tif)
broiler_manure_df <- as.data.frame(combine_rasts, xy=TRUE)   

broiler_manure <- broiler_manure_df %>% 
  rename(ID_0 = master_rgns) %>%
  group_by(ID_0) %>% 
  dplyr::summarise(our_ghg_tonnes = sum(manure_tonnes_CO2eq, na.rm = TRUE))

broiler_manure <- broiler_manure %>%
  left_join(rgn_info, by="ID_0") 

```

```{r}
fao_em <- read_csv(here("chicken_ghg/data/fao_manure_emissions.csv")) %>% 
 filter(country != "China") %>%  ## this is the sum of china mainland and islands, we separate it out
  mutate(country = ifelse(country == "Eswatini", "Swaziland", country),
         country = ifelse(country == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", country),
         country = ifelse(country == "French Guyana", "French Guiana", country),
         country = ifelse(country == "China, mainland", "China", country),
         iso3c = countrycode(country, origin="country.name", destination = "iso3c")) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(fao_tonnes = sum(tonnes_co2eq))

```

Compare
```{r}
compare_manure<- left_join(broiler_manure, fao_em, by = "iso3c") %>% 
  mutate(per_diff = abs(fao_tonnes-our_ghg_tonnes)/((fao_tonnes+our_ghg_tonnes)/2))
```

Looks good!


Look at totals 
```{r}
out_total <-compare_manure %>% 
  dplyr::summarise(us = sum(our_ghg_tonnes),
                   fao = sum(fao_tonnes, na.rm = TRUE))
```




