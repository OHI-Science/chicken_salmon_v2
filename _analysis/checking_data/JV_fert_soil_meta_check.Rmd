---
title: "JV_fert_soil_meta_check"
author: "Juliette"
date: "6/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(countrycode)
library(here)

prep <- "/home/shares/food-systems/Food_footprint/dataprep/"
raw <- "/home/shares/food-systems/Food_footprint/_raw_data/"

rgns_tif <- raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/master_rgns.tif")
food_crs <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
rgn_info <- read_csv(here("_spatial/output/master_rgns.csv"))
rgns <- read_csv(here("_spatial/output/master_rgns.csv"))

```

To make sure our fertilizer-soil-metabolism_n2o values are in the ballpark, we can compare the global (and/or country totals) total we get using our model to these data in FAO: 

"GHG emissions from synthetic fertilizers consist of direct and indirect nitrous oxide (N2O) emissions from nitrogen (N) added to agricultural soils by farmers. Specifically, N2O is produced by microbial processes of nitrification and de-nitrification taking place on the addition site (direct emissions), and after volatilization/re-deposition and leaching processes (indirect emissions)."

I think that we want to include both direct and indirect emissions

```{r}
fao_raw <- read_csv(file.path(raw, "FAO_data/v2020/synthetic_fert_meta.csv"))

fao <- fao_raw %>% 
  dplyr::select(Area, Value) %>% 
  mutate(iso3c = countrycode(Area, origin="country.name", destination = "iso3c")) %>% 
  filter(Area != "China") %>% 
  group_by(Area, iso3c) %>% 
  dplyr::summarise(total_em = sum(Value)) %>% 
  mutate(total_em = total_em*1000)

```

Read in our emissions
```{r}

n2o_list <- (list.files(file.path(prep, "crop_ghg/crop_fertilizer_N2O/co2_eq"), full = TRUE))
stack_n2o <- raster::stack(lapply(n2o_list, raster))
n2o <- sum(stack_n2o, na.rm = TRUE)

```

Convert to DF
```{r}

combine_rasts <- stack(n2o, rgns_tif)
n2o_df <- as.data.frame(combine_rasts, xy=TRUE)   

n2o_rgn <- n2o_df %>% 
  rename(ID_0 = master_rgns) %>%
  group_by(ID_0) %>% 
  dplyr::summarise(fertilizer_production = sum(layer, na.rm = TRUE))%>%
  left_join(rgn_info, by="ID_0") %>% 
  dplyr::select(-ID_0)

```

Combine our values with FAO and compare
```{r}
compare <- left_join(fao, n2o_rgn, by = "iso3c")

##plot
n2o <- ggplot(compare, aes(x = total_em, y = fertilizer_production)) +
  geom_point() +
  ylab("Total CO2eq our maps")+
  xlab("Total CO2eq FAO reported")+
  theme_bw()+
    geom_abline(intercept=0, slope=1, color="red")
```















