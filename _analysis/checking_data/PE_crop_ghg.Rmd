---
title: "PE_crop_ghg.Rmd"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Script Description
Data checking crop ghg section.

# Data information
Summary report published 2017 and data represents year 2010.
GLEAM-i have summary global data for all countries, livestock and ghg measures. We will use these to compare with our data to ensure we have approximately the same values and relative proportions of each ghg category. 

FAO. 2017. Global Livestock Environmental Assessment Model (GLEAM) [online]. Rome. [Accessed: 06/02/2020]. www.fao.org/gleam/en/

# Preamble
```{r setup, include = FALSE}
# getting packages we want
library(tidyverse)
library(here)
library(raster)
library(sf)
library(janitor)
library(kableExtra)
library(knitr)

# Raster templates
source(here("_spatial/template_raster.R"))

# File paths
raw   <- "/home/shares/food-systems/Food_footprint/_raw_data/"
prep  <- "/home/shares/food-systems/Food_footprint/dataprep/"
final <- "/home/shares/food-systems/Food_footprint/final_data/" 
stressor <- "/home/shares/food-systems/Food_footprint/stressors/"

# Import master_rgns xy df
master_rgns_xy <- vroom::vroom(paste(prep, "spatial/master_rgns_xy.csv", sep = "")) %>% 
  dplyr::select(x, y, iso3c)
master_rgns <- read_csv(here("_spatial/output/master_rgns.csv"))
rgns <- raster("/home/shares/food-systems/Food_footprint/dataprep/spatial/master_rgns.tif")

# Raster plotting funs
plot_your_logged_raster <- function(shortcut, path_extension, unit, title) {
  
  rstr <- raster(file.path(shortcut,
                        path_extension, # extension of your file path
                        ".tif",
                        fsep = ""))
  
  cellStats(rstr, stat = "sum")
  
  plot(rstr,
       legend = TRUE,
       legend.args = list(text = unit, # unit of measurement for the stressor
                          cex  = 1, 
                          side = 3, 
                          line = 1),
                          main = title)
  
  plot(log(rstr + 1),
           legend = TRUE,
           legend.args = list(text = paste(unit, "(logged)", sep = " "), 
                              cex  = 1, 
                              side = 3, 
                              line = 1),
                              main = paste(title, "(logged)", sep = " "))
}
``` 

-------------------------------------------------------------------------------
# GLEAM-i  
  
## Import and tidy
```{r, include = FALSE}
# Import
GLEAM_df <- vroom::vroom(here("_analysis/checking_data/PE_data/GLEAM_Data_public_release.csv")) %>% 
  clean_names() 

# Clean LHS
GLEAM_df_LHS <- GLEAM_df %>% 
  dplyr::select(1:4) %>% 
  row_to_names(row_number = 1, remove_row = TRUE) %>% 
  clean_names()

# Clean RHS
GLEAM_df_RHS <- GLEAM_df %>% 
  dplyr::select(5:22)

# Match units to each emission type
GLEAM_units <- GLEAM_df_RHS[1,] %>% 
  gather(key = "emission_type", value = "units")

# Collate LHS w/ RHS
GLEAM_df <- GLEAM_df_RHS[-1,] %>% 
  bind_cols(GLEAM_df_LHS) %>% 
  gather(key = "emission_type", value = "value", - c(names(GLEAM_df_LHS))) %>% 
  left_join(GLEAM_units)

# Correct value format
GLEAM_df$value <- gsub(",", "", GLEAM_df$value) %>% 
  gsub("-", 0, .) %>% 
  as.double()

# Convert from kgCO2 to tCO2
GLEAM_df <- GLEAM_df %>% 
  mutate(value = value / 1000) %>% 
  mutate(units = str_replace_all(GLEAM_df$units, 
                                 pattern = "kg", 
                                 replacement = "tonnes"))
```

-------------------------------------------------------------------------------

# Exploratory Data Analysis
```{r, echo = FALSE}
# Filter system
GLEAM_broiler_df <- GLEAM_df %>% 
  filter(animal_species %in% "Chicken",
         commodity %in% "Meat",
         production_system %in% "Broilers")

# Filters
GLEAM_emission_type_list <- unique(GLEAM_broiler_df$emission_type) 
GLEAM_emission_type_list

GLEAM_feed_emissions <- c("feed_co2", 
                          "feed_fertilizer_crop_residues_n2o")

GLEAM_farm_emissions <- c("direct_energy_co2", 
                          "manure_management_ch4",
                          "manure_management_n2o",
                          "feed_applied_deposited_manure_n2o")

# Proportion of each emission type
GLEAM_broiler_prop <- GLEAM_broiler_df %>% 
  filter(region %in% "Global" & emission_type %in% c(GLEAM_feed_emissions, GLEAM_farm_emissions)) %>% 
  mutate(proportion = value / sum(value, na.rm = TRUE)) %>% 
  dplyr::select(-c(animal_species, production_system, commodity))

GLEAM_broiler_prop %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position = "left",
                full_width = TRUE)
```

-------------------------------------------------------------------------------

# Calculate sums for our data

# Sum emissions of GLEAM data
```{r, echo = FALSE}
# Feed 
GLEAM_feed_crop_broiler_ghg_sum <- GLEAM_broiler_df %>% 
  filter(emission_type %in% GLEAM_feed_emissions & region %in% "Global") %>% 
  summarize(sum = sum(value))
GLEAM_feed_crop_broiler_ghg_sum

# Farm
GLEAM_farm_broiler_ghg_sum <- GLEAM_broiler_df %>% 
  filter(emission_type %in% GLEAM_farm_emissions & region %in% "Global") %>% 
  summarize(sum = sum(value))
GLEAM_farm_broiler_ghg_sum
```

## Sum emissions of our analyses
```{r, echo = FALSE}
# Feed emissions
our_feed_crop_broiler_ghg <- raster(file.path(stressor, 
                                              "final_data/_tif_version_raw/feed_crop_broiler_ghg.tif", 
                                              fsep = ""))
our_feed_crop_broiler_ghg_sum <- cellStats(our_feed_crop_broiler_ghg, stat = "sum")

## Farm emissions
our_farm_broiler_ghg     <- raster(file.path(stressor, "raw/farm_broiler_ghg.tif", fsep = ""))
our_farm_broiler_ghg_sum <- cellStats(our_farm_broiler_ghg, stat = "sum")
```

-------------------------------------------------------------------------------

# Compare GLEAM 2010 with our sums

## Sum comparison
```{r, echo = FALSE}
# Build a tibble
compare_ghg <- tibble(
  data_source = c("NCEAS", "GLEAM","NCEAS", "GLEAM"),
  emission_source = c("feed","feed","farm","farm"),
  total = as.numeric(c(our_feed_crop_broiler_ghg_sum, 
                       GLEAM_feed_crop_broiler_ghg_sum, 
                       our_farm_broiler_ghg_sum, 
                       GLEAM_farm_broiler_ghg_sum)
                     )
) 
compare_ghg %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position = "left",
                full_width = TRUE)
                
# Add columns to compare proportion that goes to each.
compare_ghg_proportions <- compare_ghg %>% 
  group_by(data_source) %>% 
  mutate(data_source_proportion = total / sum(total)) %>% 
  group_by(emission_source) %>% 
  mutate(emission_source_proportion = total / sum(total))

ggplot(compare_ghg_proportions, aes(x = data_source, y = total, col = emission_source)) + 
  geom_point() +
  theme_light() +
  labs(y = "tonnes CO2eq")
```

# View tables
```{r, echo = FALSE}
# By emissions source
compare_ghg_proportions %>% 
  dplyr::select(-data_source_proportion) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position = "left",
                full_width = TRUE)

# By data source
compare_ghg_proportions %>% 
  dplyr::select(-emission_source_proportion) %>% 
  arrange(data_source) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position = "left",
                full_width = TRUE)
                
```

-------------------------------------------------------------------------------

## Visualising crop emissions {.tabset .tabset-pills}

### Total Feed
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot(our_feed_crop_broiler_ghg,
     legend = TRUE,
     legend.args = list(text = "CO2eq tonnes", # unit of measurement for the stressor
                        cex  = 1, 
                        side = 3, 
                        line = 1),
                        main = "Feed crop broiler ghg")

plot(log(our_feed_crop_broiler_ghg + 1),
         legend = TRUE,
         legend.args = list(text = paste("CO2eq tonnes", "(logged)"), 
                            cex  = 1, 
                            side = 3, 
                            line = 1),
                            main = paste("Feed crop broiler ghg", "(logged)"))
```

### Total Farm
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot(our_farm_broiler_ghg,
       legend = TRUE,
       legend.args = list(text = "CO2eq tonnes", # unit of measurement for the stressor
                          cex  = 1, 
                          side = 3, 
                          line = 1),
                          main = "Farm broiler ghg")
  
plot(log(our_farm_broiler_ghg + 1),
         legend = TRUE,
         legend.args = list(text = paste("tonnes CO2eq", "(logged)"), 
                            cex  = 1, 
                            side = 3, 
                            line = 1),
                            main = paste("Farm broiler ghg", "(logged)"))
```

### Irrigation
```{r, echo = FALSE, message = FALSE, results = "asis"}
vroom::vroom(file.path(prep, "crop_ghg/crop_irrigation_ghg/whea.csv", fsep = ""), 
         col_types = "ddn") %>% 
   rasterFromXYZ(.) %>% 
   plot(.,
      legend = TRUE,
      legend.args = list(
        text = "CO2eq tonnes", # unit of measurement for the stressor
        cex  = 1, 
        side = 3, 
        line = 1),
      main = "Irrigation") 
#%>% 
#   plot(log(. + 1),
#         legend = TRUE,
#         legend.args = list(text = paste("tonnes CO2eq", "(logged)"), 
#                            cex  = 1, 
#                            side = 3, 
#                            line = 1),
#                            main = paste("Farm broiler ghg", "(logged)"))
```

### Fertilizer: production and transport
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot_your_logged_raster(prep,
                        "crop_ghg/crop_nutrient_ghg/crop_whea_all_nutrient_CO2eq",
                        "CO2eq tonnes",
                        "Fertilizer: production and transport")
```

### Crop residue leaching
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot_your_logged_raster(prep,
                 "crop_ghg/crop_residue_N2O/co2_eq/res_n2o_co2eq_whea",
                 "CO2eq tonnes",
                 "Crop residue: leaching")
```

### Crop residue burning emissions
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot_your_logged_raster(prep,
                 "crop_ghg/crop_residue_burning_ghg/co2eq_emitted/whea",
                 "CO2eq tonnes",
                 "Crop residue: burning emissions")
```

### Pesticide: production and transport
```{r, echo = FALSE, message = FALSE, results = "asis"}
plot_your_logged_raster(prep,
                 "crop_ghg/crop_pesticide_ghg/crop_whea_pesticide_CO2eq",
                 "CO2eq tonnes",
                 "Pesticide: production and transport")
```

{-}

-------------------------------------------------------------------------------

# N2O from synthetic fertilizer check
Juliette calculated N20 emissions from synthetic fertilizers using the fertilizer data and a gleam model.

Find the CO2eq for the synthentic fertilizer N20 emissions for all crops that Juliette created
Sum across all crops to get one layer that represents all the crops
Sum the global CO2eq from our data and sum the global CO2eq from FAO and compare values and report
Do a country comparison and create a plot with abline to compare country values.

# Import N2O data
```{r}
# Sum all rasters
fert_n2o_list <- list.files(path = file.path(prep,
                                             "crop_ghg/crop_fertilizer_N2O/co2_eq", 
                                             fsep = ""),
                            full = TRUE)
fert_n2o_stack <- stack(fert_n2o_list)
fert_n2o_sum <- sum(fert_n2o_stack, na.rm = TRUE)
fert_n2o_sum

# zonal sum
fert_n2o <- zonal(fert_n2o_sum, rgns, fun = "sum", progress = "text", na.rm = TRUE)
rgn_master <- vroom::vroom(here("_spatial/output/master_rgns.csv"))
fert_n2o_df <- data.frame(fert_n2o) %>%
  rename(ID_0 = zone, our_data = sum) %>%
  left_join(rgn_master, by = "ID_0")
```

# Import FAOSTAT data
```{r}
FAOSTAT_data <- vroom::vroom(here("_analysis/checking_data/PE_data/FAOSTAT_synthetic_fertilizers.csv")) %>% 
  clean_names() %>%
  filter(element %in% "Emissions (CO2eq) (Synthetic fertilizers)" & !area_code %in% 351) %>% 
  mutate(FAO_data = value * 1000)
   
# Convert FAO rgns to iso3c
FAO_rgn_codes <- vroom::vroom(here("_spatial/output/FAO_rgn_codes.csv"))
FAOSTAT_data <- left_join(FAOSTAT_data, FAO_rgn_codes, by = "area_code") %>%
  dplyr::select(iso3c, FAO_data)
```

# Compare globally
```{r}
# Check our data
fert_n2o_global_sum <- cellStats(fert_n2o_sum, stat = "sum", na.rm = TRUE)

# Check FAO values
FAOSTAT_global_sum <- sum(FAOSTAT_data$FAO_data)
```

# Compare nationally
```{r}
compare_df <- left_join(FAOSTAT_data, fert_n2o_df)

ggplot(compare_df, aes(x = our_data,  y = FAO_data)) +
  geom_point() +
  geom_abline() +
  theme_minimal()
```

-------------------------------------------------------------------------------

# Fertilizer production and transport data check

## Import fertilizer ghg maps
```{r}
crop_nutrient_ghg <- list.files(
  path    = file.path(prep, "crop_ghg/crop_nutrient_ghg"),
  pattern = "all",
  full    = TRUE) %>% 
  stack() %>% 
  sum(na.rm = TRUE)

# Compare sum before and after analysing data.
crop_nutrient_ghg_sum <- cellStats(crop_nutrient_ghg, "sum", na.rm = TRUE)

rgn_nutrient_ghg <- zonal(crop_nutrient_ghg, rgns, fun = "sum", 
                      progress = "text", na.rm = TRUE)

rgn_nutrient_ghg_df <- data.frame(rgn_nutrient_ghg) %>%
  rename(ID_0 = zone, ghg_nutrient = sum) %>%
  left_join(master_rgns, by = "ID_0")
```

## Import FAO data
```{r}
FAO_nutrient <- vroom::vroom(here("crop_nutrient/data/FAOSTAT_2016_nutrient_agri_use.csv")) %>% 
  clean_names() %>% 
  rename(nutrient = item, FAO_country_tonnes = value) %>% 
  mutate(nutrient = case_when(
    nutrient %in% "Nutrient nitrogen N (total)"     ~ "N",
    nutrient %in% "Nutrient phosphate P2O5 (total)" ~ "P2O5",
    nutrient %in% "Nutrient potash K2O (total)"     ~ "K2O"))  # SRB without XKO

FAO_nutrient <- FAO_nutrient %>% 
  mutate(area_code = if_else(area_code %in% 272, 275, area_code)) %>%  # XKO
  bind_rows(.) %>%
  mutate(area_code = if_else(area_code %in% 272, 286, area_code)) %>%
  unique() %>% 
  filter(!area_code %in% 351) # Code 351 values are for all of China, including MAC, HKG, TWN.

# Convert FAO rgns to iso3c
FAO_rgn_codes <- vroom::vroom(here("_spatial/output/FAO_rgn_codes.csv"))

FAO_nutrient <- left_join(FAO_nutrient, FAO_rgn_codes, by = "area_code") %>% 
  dplyr::select(nutrient, FAO_country_tonnes, iso3c) %>% 
  unique()

# Allocate fertilizer data to Serbia and Kosovo
SRB_XKO <- vroom::vroom(here("crop_farm/data/prod_crop_rgns.csv")) %>% 
  filter(iso3c %in% c("XKO", "SRB") & prod_system %in% "A") %>% 
  group_by(iso3c) %>% 
  summarize(country_production = sum(country_production)) %>% 
  mutate(relative_proportion = country_production / sum(country_production))

FAO_nutrient$FAO_country_tonnes[FAO_nutrient$iso3c %in% "SRB"] <- 
  FAO_nutrient$FAO_country_tonnes[FAO_nutrient$iso3c %in% "SRB"] * 
  SRB_XKO$relative_proportion[SRB_XKO$iso3c %in% "SRB"]

FAO_nutrient$FAO_country_tonnes[FAO_nutrient$iso3c %in% "XKO"] <- 
  FAO_nutrient$FAO_country_tonnes[FAO_nutrient$iso3c %in% "XKO"] * 
  SRB_XKO$relative_proportion[SRB_XKO$iso3c %in% "XKO"]

# I gave these autonomous regions the same area_codes as POR and GBR respectively.
FAO_nutrient$FAO_country_tonnes[FAO_nutrient$iso3c %in% c("XMI", "GGY")] <- 0
```

## Multiply FAO data by Global Average emission factor for each nutrient (source: LEAP dataset)
```{r}
nutrient_EF <- vroom::vroom(here("crop_ghg/data/FAO_2017_LEAP_EF.csv")) %>% 
  clean_names() %>% 
  rename(LEAP_region = region, 
         N           = n,
         P2O5        = p2o5,
         K2O         = k2o) %>% 
  pivot_longer(cols      = c(N, P2O5, K2O, lime),
               names_to  = "nutrient",
               values_to = "emission_factor") %>% 
  filter(!emission_factor %in% "lime")

nutrient_EF_global <- nutrient_EF %>% filter(LEAP_region %in% "Global Average")

FAO_nutrient_ghg <- left_join(FAO_nutrient, nutrient_EF_global) %>% 
  mutate(nutrient_tonnes = emission_factor * FAO_country_tonnes)

FAO_nutrient_ghg_sum <- FAO_nutrient_ghg %>% 
  summarize(CO2eq_tonnes = sum(nutrient_tonnes, na.rm = TRUE))
FAO_nutrient_ghg_sum

```

```{r}
nutrient_df <- vroom::vroom(here("crop_nutrient/data/nutrient_df.csv"))
nutrient_df <- left_join(nutrient_df, nutrient_EF_global) %>% 
  mutate(CO2eq_tonnes = emission_factor * fertilizer_tonnes)

# Ensure proportions for each nutrient add to 1
nutrient_df %>% 
  filter(iso3c %in% c("USA", "BRA", "SRB", "SDN", "TWN", "ALA", "XMI", "XKO", "PRT", "GBR", "GGY")) %>%
  group_by(iso3c, nutrient) %>% 
  summarize(total_prop = sum(SPAM_country_prop))

# Expecting reasonable values, ALA and XMI should be zeros due to absence of fertilizer data.
nutrient_df %>% 
  filter(iso3c %in% c("USA", "BRA", "SRB", "SDN", "TWN", "ALA", "XMI", "XKO", "PRT", "GBR", "GGY")) %>%
  group_by(iso3c) %>% 
  summarize(total_tonnes = sum(fertilizer_tonnes))

nutrient_df %>%
  summarize(CO2eq_tonnes = sum(CO2eq_tonnes, na.rm = TRUE))
```

## Comparison
```{r}
nutrient_ghg_sum_diff <- (FAO_nutrient_ghg_sum - crop_nutrient_ghg_sum) / crop_nutrient_ghg_sum
```

## Rgn comparison
```{r}
FAO_nutrient_ghg_rgns <- FAO_nutrient_ghg %>% 
  group_by(iso3c) %>% 
  summarize(FAO_ghg_nutrient = sum(nutrient_tonnes, na.rm = TRUE))
nutrient_ghg_rgn_comparison <- left_join(FAO_nutrient_ghg_rgns, rgn_nutrient_ghg_df)
nutrient_ghg_rgn_comparison <- nutrient_ghg_rgn_comparison %>% 
  mutate(diff = FAO_ghg_nutrient - ghg_nutrient) %>% 
  arrange(desc(diff))

# nutrient df comparison
nutrient_df_rgns <- nutrient_df %>% 
  group_by(iso3c) %>% 
  summarize(CO2eq_tonnes = sum(CO2eq_tonnes, na.rm = TRUE))

nutrient_df_rgn_comparison <- left_join(nutrient_df_rgns, rgn_nutrient_ghg_df)

nutrient_df_rgn_comparison <- nutrient_df_rgn_comparison %>% 
  mutate(diff = CO2eq_tonnes - ghg_nutrient) %>% 
  arrange(diff)
```

-------------------------------------------------------------------------------

# Pesticide emissions for production and transport - data check

Greenpeace had a global values of 410M fertilizer production and 72M for pesticide production. We would expect the fertilizer emissions to pesticide emissions ratio within a reasonable distance from 5.69 in our data.

```{r}
# Sum at global level
crop_pest_ghg <- list.files(file.path(prep, "crop_ghg/crop_pesticide_ghg/"), full = TRUE) %>% 
  stack() %>% 
  sum(na.rm = TRUE)

# Sum at rgn level
crop_pest_ghg_sum <- cellStats(crop_pest_ghg, "sum", na.rm = TRUE)

# Expect ratio close to 5.69 and values around 410M:72M
crop_nutrient_ghg_sum / crop_pest_ghg_sum

options(digits = 2)
tibble(
  category        = c("Fertilizer to Pesticide emissions ratio", 
                      "Fertilizer production", 
                      "Pesticide production"),
  expected_values = c(4.1e8 / 7.2e7, 
                      4.1e8, 
                      7.2e7),
  output          = c(crop_nutrient_ghg_sum / crop_pest_ghg_sum, 
                      crop_nutrient_ghg_sum, 
                      crop_pest_ghg_sum)
     ) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position = "left",
                full_width = FALSE)
```

## Zonal check
```{r}
rgn_pest_ghg <- zonal(crop_pest_ghg, rgns, fun = "sum", 
                      progress = "text", na.rm = TRUE)

data.frame(rgn_pest_ghg) %>%
  rename(ID_0 = zone, ghg_pest = sum) %>%
  left_join(master_rgns, by = "ID_0") %>% 
  filter(iso3c %in% c("USA", "BRA", "SRB", "SDN", "TWN", "ALA", "XMI", "XKO", "PRT", "GBR", "GGY")) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                position          = "left",
                full_width        = FALSE)
```
