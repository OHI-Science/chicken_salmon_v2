---
title: "Convert CSVs to tifs and check"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this script is to convert the csv files to tifs and check.  We create two forms of the scripts:
1. Raw values
2. Values divided by the area of the raster cell, km2

The outputs are tif files located on Aurora in the final_data folder: 

_tif_version_per_cell
_tif_version_per_km2

```{r}

library(rgdal)
library(sp)
library(raster)
library(tidyverse)
library(here)

```

# clear out listed files in tif folders. Want to make sure we have a clean start.
```{r}

do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_km2", full.names = TRUE)))
do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_cell", full.names = TRUE)))

```

This converts each csv into a tif.  It also collects information on the raster data so we can error check.  With the exception of area, these are raw values that are not standardized by raster cell area.
```{r}

files <- list.files("/home/shares/food-systems/Food_footprint/final_data", full=TRUE, pattern=".csv")

raster_check <- data.frame()

for(file in files){
  # file <- files[2]

name <- basename(file)
name <- gsub(".csv", "", name)
csv_file <- read_csv(file, col_types = "ddd")
raster_file <- rasterFromXYZ(csv_file)
crs(raster_file) <- CRS("+init=epsg:4326")
tmp_values <- values(raster_file)
extent_data <- data.frame(file = name, 
                          xmin = extent(raster_file)@xmin, 
                          xmax = extent(raster_file)@xmax, 
                          ymin = extent(raster_file)@ymin, 
                          ymax = extent(raster_file)@ymax,
                          variable = names(raster_file),
                          min = minValue(raster_file),
                          max = maxValue(raster_file),
                          sum_cells = cellStats(raster_file, sum, na.rm=TRUE),
                          quant_50 = quantile(raster_file, c(0.5)),
                          mean = cellStats(raster_file, mean, na.rm=TRUE),
                          total_zero = sum(tmp_values==0, na.rm=TRUE),
                          total_NA = sum(is.na(tmp_values)),
                          total_greater_zero = sum(tmp_values>0, na.rm=TRUE))

raster_check <- rbind(raster_check, extent_data)

# the disturbance raster is  area corrected so that raster will be saved in the area-corrected folder
# a raw unit raster of km2 will be saved in the next loop. 
if(grepl("disturbance", file)){
writeRaster(raster_file, sprintf("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_km2/%s_per_area.tif", name), overwrite=TRUE)
} else {
  writeRaster(raster_file, sprintf("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_cell/%s.tif", name), overwrite=TRUE)
}
}
# check extents are -90/90/-180/180
# and number of files is correct
summary(raster_check)
## All looks good!!

write_csv(raster_check, here("_analysis/check_final_rasters.csv"))
```


Control for differences in raster cells area.  

```{r}
files_area_adjust <- list.files("/home/shares/food-systems/Food_footprint/final_data", full=TRUE, pattern=".csv")
files_area_adjust <- grep("consumption", files_area_adjust, value=TRUE, invert=TRUE) # Do not area correct rasters describing proportions of crop going to animal feed

for(file in files_area_adjust){ # file = files[2] 
  name <- basename(file)
  name <- gsub(".csv", "", name)

  csv_file <- read_csv(file, col_types = "ddd")
  stressor_raster <- rasterFromXYZ(csv_file)
  crs(stressor_raster) <- CRS("+init=epsg:4326")
  
  raster_area <- area(stressor_raster)
  #plot(disturb_rast_area)
  
if(grepl("disturbance", file)){
   stressor_area_adjust <-  stressor_raster * raster_area
writeRaster(stressor_area_adjust, sprintf("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_cell/%s.tif", name), overwrite=TRUE)
} else {
   raster_area_adjust <- stressor_raster/raster_area
  writeRaster(raster_area_adjust, sprintf("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_km2/%s_per_area.tif", name), overwrite=TRUE)
}
}

```

Delete a few crop consumption datasets that we don't report:
```{r}

delete_raw <- list.files("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_cell", pattern="acof|rcof|toba|teas", full=TRUE)
do.call(file.remove, list(delete_raw))

delete_raw <- list.files("/home/shares/food-systems/Food_footprint/final_data/_tif_version_per_km2", pattern="acof|rcof|toba|teas", full=TRUE)
do.call(file.remove, list(delete_raw))

```